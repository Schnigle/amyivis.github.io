<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>IVIS2019-Insight</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet">
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/resume.min.css" rel="stylesheet">
      <script src="https://d3js.org/d3.v3.min.js"></script>
      <script src="https://code.jquery.com/jquery-1.7.2.min.js"></script>

    <style>
        body {
            font-family:"avenir next", Arial, sans-serif;
            font-size: 12px;
            color: #696969;
        }

        .ticks {
            font-size: 10px;
        }

        .track,
        .track-inset,
        .track-overlay {
            stroke-linecap: round;
        }

        .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .track-inset {
            stroke: #ddd;
            stroke-width: 8px;
        }

        .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            stroke: transparent;
            cursor: crosshair;
        }

        .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
        }

        #chart {
            background: #fff;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        .title {
            font-weight: bold;
            font-size: 24px;
            text-align: center;
            margin-top: 6px;
            margin-bottom: 6px;
        }
        text {
            pointer-events: none;
        }

        .grandparent text {
            font-weight: bold;
        }

        rect {
            fill: none;
            stroke: #fff;
        }

        rect.parent,
        .grandparent rect {
            stroke-width: 2px;
        }

        rect.parent {
            cursor: pointer;
        }

        rect.parent:hover {
            opacity: 0.7;
        }

        .grandparent rect {
            fill: #9e9ac8;
        }

        .grandparent:hover rect {
            fill: #9e9ac8;
        }

        .children rect.parent,
        .grandparent rect {
            cursor: pointer;
        }

        .children rect.parent {
            fill: #bbb;
            fill-opacity: .5;
        }

        .children:hover rect.child {
            fill: #bbb;
        }

        .ctext {
            font-size: 11px;
        }
        .toolTip {
            position: absolute;
            display: none;
            width: auto;
            height: auto;
            background: none repeat scroll 0 0 black;
            border: 0 none;
            border-radius: 8px 8px 8px 8px;
            box-shadow: -3px 3px 15px #888888;
            color: white;
            font: 12px sans-serif;
            padding: 5px;
            text-align: center;
        }
    </style>

</head>
<body id="page-top">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
    <a class="navbar-brand js-scroll-trigger" href="#page-top">
      <span class="d-block d-lg-none">Insight</span>
      <span class="d-none d-lg-block">
        <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="img/profile.jpg" alt="">
      </span>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#experience">Overview</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#education">Insight</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#skills">Skills</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#interests">Members</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container-fluid p-0">

    <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="about">
      <div class="w-100">
        <h1 class="mb-0">Insight
          <span class="text-primary">Visualization Project</span>
        </h1>
        <div class="subheading mb-5">Visualising Financial Data: PDMR transactions and net short positions
          <a href="https://fi.se/">Swedish FSA</a>
        </div>
        <p class="lead mb-5">We are students from 2019 information visualization course in KTH. We got an offer from Swidish FSA and aims to visualise transaction patterns on the Swedish capital market. We hope to support them to improve market transparency for a more effective market and prevent market abuse.</p>
        <div class="social-icons">
          <a href="#">
            <i class="fab fa-linkedin-in"></i>
          </a>
          <a href="#">
            <i class="fab fa-github"></i>
          </a>
          <a href="#">
            <i class="fab fa-twitter"></i>
          </a>
          <a href="#">
            <i class="fab fa-facebook-f"></i>
          </a>
        </div>
      </div>
    </section>

    <hr class="m-0">

    <section class="resume-section p-3 p-lg-5 d-flex justify-content-center" id="experience">
      <div class="w-100">
        <h2 class="mb-5">Treemap of Short Selling Data</h2>
         <div id="chart"></div>
      </div>

    </section>

    <hr class="m-0">

    <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="education">
      <div class="w-100">
        <h2 class="mb-5">Bar chart of Insight Data</h2>


      </div>
    </section>

    <hr class="m-0">

    <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="skills">
      <div class="w-100">
        <h2 class="mb-5">Skills</h2>

        <div class="subheading mb-3">Programming Languages &amp; Tools</div>
        <ul class="list-inline dev-icons">
          <li class="list-inline-item">
            <i class="fab fa-js-square"></i>
          </li>
          <li class="list-inline-item">
            <i class="fab fa-angular"></i>
          </li>
          <li class="list-inline-item">
            <i class="fab fa-react"></i>
          </li>
          <li class="list-inline-item">
            <i class="fab fa-node-js"></i>
          </li>
          <li class="list-inline-item">
            <i class="fab fa-sass"></i>
          </li>
          <li class="list-inline-item">
            <i class="fab fa-less"></i>
          </li>
          <li class="list-inline-item">
            <i class="fab fa-wordpress"></i>
          </li>
        </ul>

        <div class="subheading mb-3">Workflow</div>
        <ul class="fa-ul mb-0">
          <li>
            <i class="fa-li fa fa-check"></i>
            Database Setting</li>
          <li>
            <i class="fa-li fa fa-check"></i>
            Visualization Desigen</li>
          <li>
            <i class="fa-li fa fa-check"></i>
           Front-end Coding</li>
          <li>
            <i class="fa-li fa fa-check"></i>
            Back-end Coding</li>
        </ul>
      </div>
    </section>

    <hr class="m-0">

    <section class="resume-section p-3 p-lg-5 d-flex align-items-center" id="interests">
      <div class="w-100">
        <h2 class="mb-5">Team Members</h2>
        <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="img/1.jpg" alt="">
        <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="img/2.jpg" alt="">
        <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="img/3.jpg" alt="">
        <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="img/4.jpg" alt="">
        <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="img/5.jpg" alt="">
            <p>XingAn &amp;Fredrik Albrektson &amp; Haoqing Shen &amp; Tomas Andersson &amp; Omer Ahmed</p>
      </div>
    </section>

    <hr class="m-0">


  </div>
  <script>
      
      
      window.addEventListener('message', function(e) {
                              var opts = e.data.opts,
                              data = e.data.data;
                              
                              return main(opts, data);
                              });
                              
                              var defaults = {
                                  margin: {top: 24, right: 0, bottom: 0, left: 0},
                                  rootname: "TOP",
                                  format: ",d",
                                  title: "",
                                  width: 960,
                                  height: 500
                              };
  var tool = d3.select("body").append("div").attr("class", "toolTip");
  
  function main(o, data) {
      var root,
      opts = $.extend(true, {}, defaults, o),
      formatNumber = d3.format(opts.format),
      rname = opts.rootname,
      margin = opts.margin,
      theight = 36 + 16;
      
      $('#chart').width(opts.width).height(opts.height);
      var width = opts.width - margin.left - margin.right,
      height = opts.height - margin.top - margin.bottom - theight,
      transitioning;
      
      
      var pur=["#3f007d","#54278f","#6a51a3","#807dba","#9e9ac8","#bcbddc", "#dadaeb","#efedf5","#fcfbfd"];
      var color = d3.scale.ordinal().range(pur);
      
      var x = d3.scale.linear()
      .domain([0, width])
      .range([0, width]);
      
      var y = d3.scale.linear()
      .domain([0, height])
      .range([0, height]);
      
      var treemap = d3.layout.treemap()
      .children(function(d, depth) { return depth ? null : d._children; })
      .sort(function(a, b) { return a.value - b.value; })
      .ratio(height / width * 0.5 * (1 + Math.sqrt(5)))
      .round(false);
      
      var svg = d3.select("#chart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.bottom + margin.top)
      .style("margin-left", -margin.left + "px")
      .style("margin.right", -margin.right + "px")
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      .style("shape-rendering", "crispEdges");
      
      var grandparent = svg.append("g")
      .attr("class", "grandparent");
      
      grandparent.append("rect")
      .attr("y", -margin.top)
      .attr("width", width)
      .attr("height", margin.top);
      
      grandparent.append("text")
      .attr("x", 6)
      .attr("y", 6 - margin.top)
      .attr("dy", ".75em");
      
      if (opts.title) {
          $("#chart").prepend("<p class='title'>" + opts.title + "</p>");
      }
      if (data instanceof Array) {
          root = { key: rname, values: data };
      } else {
          root = data;
      }
      
      initialize(root);
      accumulate(root);
      //console.log(root.position_in_percent);
      layout(root);
      
      display(root);
      
      if (window.parent !== window) {
          var myheight = document.documentElement.scrollHeight || document.body.scrollHeight;
          window.parent.postMessage({height: myheight}, '*');
      }
      
      function initialize(root) {
          root.x = root.y = 0;
          root.dx = width;
          root.dy = height;
          root.depth = 0;
      }
      
      // Aggregate the values for internal nodes. This is normally done by the
      // treemap layout, but not here because of our custom implementation.
      // We also take a snapshot of the original children (_children) to avoid
      // the children being overwritten when when layout is computed.
      function accumulate(d) {
          d.value = d.position_in_percent;
          return (d._children = d.values)
          ? d.value = d.values.reduce(function(p, v) { return p + accumulate(v); }, 0)
          : d.value;
      }
      // Compute the treemap layout recursively such that each group of siblings
      // uses the same size (1×1) rather than the dimensions of the parent cell.
      // This optimizes the layout for the current zoom state. Note that a wrapper
      // object is created for the parent node for each group of siblings so that
      // the parent’s dimensions are not discarded as we recurse. Since each group
      // of sibling was laid out in 1×1, we must rescale to fit using absolute
      // coordinates. This lets us use a viewport to zoom.
      function layout(d) {
          if (d._children) {
              treemap.nodes({_children: d._children});
              d._children.forEach(function(c) {
                                  c.x = d.x + c.x * d.dx;
                                  c.y = d.y + c.y * d.dy;
                                  c.dx *= d.dx;
                                  c.dy *= d.dy;
                                  c.parent = d;
                                  layout(c);
                                  });
          }
      }
      
      function display(d) {
          grandparent
          .datum(d.parent)
          .on("click", transition)
          .select("text")
          .text(name(d));
          
          var g1 = svg.insert("g", ".grandparent")
          .datum(d)
          .attr("class", "depth");
          
          var url="http://ivis.southeastasia.cloudapp.azure.com:5000/histPosition/"
          
          var g = g1.selectAll("g")
          .data(d._children)
          .enter().append("g")
          .on("mousemove", function (d) {
              tool.style("left", d3.event.pageX + 10 + "px")
              tool.style("top", d3.event.pageY - 20 + "px")
              tool.style("display", "inline-block");
              tool.html(
                        
                        
                        
                        d.key
                        //d.values[0].key
                        //d3.nest().key(function(d) { return d.issuer_name; }).key(function(d) { return d.position_holder; })
                        //d.children ? null : d.name + "<br>" + ' $ ' + formatMoney(Math.round(d.size * 1000)) + ' ' + roundToTwo((d.value / 16147370.2) * 100) + '%'
                        );
              }).on("mouseout", function (d) {
                    tool.style("display", "none");
                    });
                    
                    g.filter(function(d) { return d._children; })
                    .classed("children", true)
                    .on("click", transition);
                    
                    // Very hacky solution, but I didn't find any other way to add OnClick to children
                    g.on("click", transition)
                    
                    var children = g.selectAll(".child")
                    .data(function(d) { return d._children || [d]; })
                    .enter().append("g");
                    
                    children.append("rect")
                    .attr("class", "child")
                    .call(rect)
                    .append("title")
                    .text(function(d) { return d.key + " (" + formatNumber(d.value) + ")"; });
                    children.append("text")
                    .attr("class", "ctext")
                    .text(function(d) {
                          var val = d.value;
                          //var hold = d.position_holder;
                          //console.log(d.position_holder)
                          if (!isNaN(val)) {
                          if(!d._children){
                          return("Trander short " + val.toFixed(2) + "%");}
                          }
                          /*if(d.parent){
                           return ("Trader short " + val.toFixed(2) + "%");}
                           else{
                           return ("Position Holder" + hold + "/n" +"Trader short" + val.toFixed(2) + "%");}
                           }*/
                          //return "ISIN: " + val;
                          })
                          .call(text2);
                          
                          g.append("rect")
                          .attr("class", "parent")
                          .call(rect);
                          
                          var t = g.append("text")
                          .attr("class", "ptext")
                          .attr("dy", ".75em")
                          
                          t.append("tspan")
                          .text(function(d) {
                            
                             if(d._children[0]._children == undefined){
                            return d.key;
                        }
                        else{
                            return d.key.slice(0, 6);
                        }

                          
                          });
                          t.append("tspan")
                          .attr("dy", "1.0em")
                          .text(function(d) { return formatNumber(d.value); });
                          t.call(text);
                          
                          g.selectAll("rect")
                          .style("fill", function(d) { return color(d.value); });
                          
                          function transition(d) {
                              //console.log(d)
                              if (transitioning || !d) return;
                              if (d._children[0]._children == undefined) {  // Leaf nodes have no children.
                                  window.open('barchart/index.html?isin=' + d.key, '_blank');
                                  return;
                              }
                              
                              transitioning = true;
                              
                              var g2 = display(d),
                              t1 = g1.transition().duration(750),
                              t2 = g2.transition().duration(750);
                              
                              // Update the domain only after entering new elements.
                              x.domain([d.x, d.x + d.dx]);
                              y.domain([d.y, d.y + d.dy]);
                              
                              // Enable anti-aliasing during the transition.
                              svg.style("shape-rendering", null);
                              
                              // Draw child nodes on top of parent nodes.
                              svg.selectAll(".depth").sort(function(a, b) { return a.depth - b.depth; });
                              
                              // Fade-in entering text.
                              g2.selectAll("text").style("fill-opacity", 0);
                              
                              // Transition to the new view.
                              t1.selectAll(".ptext").call(text).style("fill-opacity", 0);
                              t1.selectAll(".ctext").call(text2).style("fill-opacity", 0);
                              t2.selectAll(".ptext").call(text).style("fill-opacity", 1);
                              t2.selectAll(".ctext").call(text2).style("fill-opacity", 1);
                              t1.selectAll("rect").call(rect);
                              t2.selectAll("rect").call(rect);
                              
                              // Remove the old node when the transition is finished.
                              t1.remove().each("end", function() {
                                               svg.style("shape-rendering", "crispEdges");
                                               transitioning = false;
                                               });
                          }
                          
                          return g;
      }
      
      function text(text) {
          var offset = 6;
          text.selectAll("tspan")
          .attr("x", function(d) { return x(d.x + d.dx/2)-this.getComputedTextLength()/2 ; })
          text.attr("x", function(d) { return x(d.x + d.dx/2)-offset ; })
          .attr("y", function(d) { return y(d.y + d.dy/2)-offset ; })
          .style("font-weight", "bold");
          
          var minFontSize = 4;
          var maxFontSize = 20;
          for (i = maxFontSize; i >= minFontSize; i--) {
              text.style("font-size", function(d){
                         if ((this.getComputedTextLength() + offset) < x(d.x + d.dx) - x(d.x)) {
                         //cause an error to avoid actual errors
                         return false;
                         }
                         return i + "px";
                         })
          }
      }
      
      function text2(text) {
          text.attr("x", function(d) { return x(d.x + d.dx/2) - this.getComputedTextLength()/2; })
          .attr("y", function(d) { return y(d.y + d.dy/2) + 12; })
          .style("opacity", function(d) { return this.getComputedTextLength() < x(d.x + d.dx) - x(d.x) ? 1 : 0; });
      }
      
      /*function text(text) {
       var offset = 6;
       text.selectAll("tspan")
       .attr("x", function(d) { return x(d.x) + offset; })
       text.attr("x", function(d) { return x(d.x) + offset; })
       .attr("y", function(d) { return y(d.y) + offset; })
       .style("font-weight", "bold");
       
       var minFontSize = 4;
       var maxFontSize = 20;
       for (i = maxFontSize; i >= minFontSize; i--) {
       text.style("font-size", function(d){
       if ((this.getComputedTextLength() + offset) < x(d.x + d.dx) - x(d.x)) {
       //cause an error to avoid actual errors
       return false;
       }
       return i + "px";
       })
       }
       }
       
       function text2(text) {
       text.attr("x", function(d) { return x(d.x + d.dx) - this.getComputedTextLength() - 6; })
       .attr("y", function(d) { return y(d.y + d.dy) - 6; })
       .style("opacity", function(d) { return this.getComputedTextLength() < x(d.x + d.dx) - x(d.x) ? 1 : 0; });
       }*/
      
      function rect(rect) {
          rect.attr("x", function(d) { return x(d.x); })
          .attr("y", function(d) { return y(d.y); })
          .attr("width", function(d) { return x(d.x + d.dx) - x(d.x); })
          .attr("height", function(d) { return y(d.y + d.dy) - y(d.y); });
      }
      
      function name(d) {
          var val = +d["value"];  //string to int
          
          val = val.toFixed(2); //truncate decimals
          if (d.parent) {
              return name(d.parent) + " / " + d.key + " (" + val + "%)"
          } else {
              return d.key /*+ " (" + val + "%)"*/;
          }
      }
  }
  
  var formatmon = function (date) {
      var y = date.getFullYear();
      var m = date.getMonth() + 1;
      m = m &lt; 10 ? ('0' + m) : m;
      var d = date.getDate();
      d = d &lt; 10 ? ('0' + d) : d;
      return y + '-' + m + '-' + d;
  };
  
  var url="http://ivis.southeastasia.cloudapp.azure.com:5000/histPosition/"
  if (window.location.hash === "") {
      d3.json(url, function(err, res) {
              if (!err) {
              //if(formatmon(res.position_date)=="2019-01-28"){
              //console.log(res.position_date);
              var data = d3.nest().key(function(d) { return d.issuer_name; }).key(function(d) { return d.isin; }).entries(res);
              var ph = d3.nest().key(function(d){return d.issuer_name;}).key(function(d){return d.isin; }).entries(res);
              main({title: "ShortsellingOverview"}, {key: "Short Stocks", values: data});
              
              //console.log(data)//console.log(data);
              //   }
              }
              });
  }
  
      </script>
  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Plugin JavaScript -->
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

  <!-- Custom scripts for this template -->
  <script src="js/resume.min.js"></script>

</body>

</html>
